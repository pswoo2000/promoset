<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>í”„ë¡œëª¨ì…˜ ìë™ ì„¸íŒ… v6.0</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
<style>
*{box-sizing:border-box;margin:0;padding:0}
::selection{background:#4ecdc444}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:#c0c0cc;border-radius:4px}
body{min-height:100vh;background:#f3f4f6;color:#1f2937;font-family:'Pretendard','Apple SD Gothic Neo',-apple-system,sans-serif;padding:28px 20px}
.wrap{max-width:1200px;margin:0 auto}
input[type="date"],input[type="number"]{background:#fff;border:1px solid #d1d5db;color:#1f2937;padding:8px 12px;border-radius:8px;font-size:13px;font-family:inherit;outline:none;transition:all .2s;-webkit-appearance:none}
input[type="date"]:focus,input[type="number"]:focus{border-color:#10b981;box-shadow:0 0 0 2px #10b98122}
input[type="number"]::-webkit-inner-spin-button{opacity:1}
@keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.fade-up{animation:fadeUp .4s ease-out both}
.d1{animation-delay:.05s}.d2{animation-delay:.1s}.d3{animation-delay:.15s}.d4{animation-delay:.2s}.d5{animation-delay:.25s}.d6{animation-delay:.3s}
.card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;margin-bottom:20px;box-shadow:0 1px 3px #0000000a}
.card-body{padding:20px 22px}
.card-title{font-size:14px;font-weight:600;color:#374151;margin-bottom:14px;display:flex;align-items:center;gap:8px}
.stats{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:24px}
.stat{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:16px 14px;box-shadow:0 1px 3px #0000000a}
.stat-l{font-size:11px;color:#9ca3af;font-weight:500;margin-bottom:8px;letter-spacing:.5px}
.stat-v{font-size:26px;font-weight:700;font-variant-numeric:tabular-nums}
.upload-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
.upload-grid.single{grid-template-columns:1fr}
.uz{border:2px dashed #d1d5db;border-radius:12px;padding:20px 16px;text-align:center;transition:all .3s;cursor:pointer;background:#f9fafb;position:relative}
.uz:hover,.uz.over{border-color:#10b981;background:#ecfdf5}
.uz.done{border-color:#10b98166;border-style:solid;background:#ecfdf5}
.uz .num{font-size:22px;margin-bottom:6px;transition:all .3s}
.uz.done .num{color:#10b981;font-size:18px}
.uz .lb{font-size:13px;color:#6b7280;font-weight:600;margin-bottom:4px}
.uz.done .lb{color:#059669}
.uz .fn{font-size:11px;color:#9ca3af;margin-top:4px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;padding:0 4px}
.uz.done .fn{color:#6b7280}
.uz .opt-badge{position:absolute;top:8px;right:8px;font-size:9px;color:#9ca3af;background:#f3f4f6;padding:2px 6px;border-radius:4px}
.uz .rm{position:absolute;top:8px;left:8px;font-size:14px;color:#ef4444;cursor:pointer;display:none;background:#fef2f2;border-radius:50%;width:20px;height:20px;line-height:20px;text-align:center}
.uz.done .rm{display:block}
.btn{padding:10px 20px;border-radius:10px;font-size:14px;font-family:inherit;font-weight:600;cursor:pointer;transition:all .2s;border:none}
.btn-p{background:linear-gradient(135deg,#10b981,#059669);color:#fff;box-shadow:0 4px 14px #10b98133}
.btn-p:hover{box-shadow:0 4px 20px #10b98155;transform:translateY(-1px)}
.btn-p:disabled{opacity:.35;cursor:not-allowed;transform:none;box-shadow:none}
.btn-s{background:#fff;border:1px solid #d1d5db;color:#6b7280;padding:7px 14px;font-size:12px;border-radius:9px;font-family:inherit;cursor:pointer;transition:all .15s}
.btn-s:hover{border-color:#10b981;color:#059669}
.btn-t1{background:#dbeafe;border:1px solid #93c5fd;color:#1d4ed8;padding:7px 14px;font-size:12px;font-weight:600;border-radius:9px;font-family:inherit;cursor:pointer;transition:all .15s}
.btn-t1:hover{background:#bfdbfe}
.btn-t2{background:#fce7f3;border:1px solid #f9a8d4;color:#be185d;padding:7px 14px;font-size:12px;font-weight:600;border-radius:9px;font-family:inherit;cursor:pointer;transition:all .15s}
.btn-t2:hover{background:#fbcfe8}
.mode-toggle{display:flex;background:#f3f4f6;border:1px solid #e5e7eb;border-radius:10px;overflow:hidden;margin-bottom:16px}
.mode-btn{flex:1;padding:10px 12px;font-size:12px;font-family:inherit;font-weight:500;cursor:pointer;border:none;background:transparent;color:#9ca3af;transition:all .2s;text-align:center}
.mode-btn.on{background:#fff;color:#1f2937;font-weight:600;box-shadow:inset 0 -2px 0 #10b981}
.tabs{display:flex;gap:4px;padding:14px 22px 0;border-bottom:1px solid #e5e7eb}
.tab{background:transparent;border:none;color:#9ca3af;padding:10px 16px;font-size:13px;font-family:inherit;cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-1px;transition:all .2s}
.tab.on{color:#1f2937;font-weight:600;border-bottom-color:#10b981}
.tab-c{margin-left:6px;font-size:11px;padding:2px 7px;border-radius:10px;background:#f3f4f6;color:#9ca3af}
.tab.on .tab-c{background:#ecfdf5;color:#059669}
table{width:100%;border-collapse:collapse;font-size:13px}
th{padding:11px 12px;text-align:left;color:#9ca3af;font-weight:500;font-size:11px;letter-spacing:.3px;border-bottom:1px solid #e5e7eb;white-space:nowrap}
th.r{text-align:right}
td{padding:11px 12px;border-bottom:1px solid #f3f4f6}
tr.dr:hover td{background:#f9fafb}
td.r{text-align:right;font-variant-numeric:tabular-nums}
td.mono{font-family:'SF Mono',monospace;font-size:11.5px;color:#6b7280}
td.name{max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:#374151}
.badge{font-size:11px;font-weight:600;padding:4px 10px;border-radius:8px;white-space:nowrap;display:inline-block}
.b-new{color:#059669;background:#ecfdf5;border:1px solid #10b98130}
.b-ext{color:#d97706;background:#fffbeb;border:1px solid #f59e0b30}
.b-con{color:#dc2626;background:#fef2f2;border:1px solid #ef444430}
.b-warn{color:#ea580c;background:#fff7ed;border:1px solid #f9731630}
.b-exist{color:#6366f1;background:#eef2ff;border:1px solid #6366f130}
.b-none{color:#9ca3af;background:#f9fafb;border:1px solid #e5e7eb}
.b-t1{color:#1d4ed8;background:#dbeafe;border:1px solid #93c5fd50}
.b-t2{color:#be185d;background:#fce7f3;border:1px solid #f9a8d450}
.t-foot{padding:14px 22px;border-top:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;background:#f9fafb;font-size:12px;border-radius:0 0 16px 16px;flex-wrap:wrap;gap:10px}
.sub-row{font-size:11px;color:#6b7280;padding:2px 14px 12px;border-bottom:1px solid #f3f4f6}
.logic{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.lc{border-radius:12px;padding:14px 16px}
.lc .ic{font-size:16px;margin-bottom:8px}
.lc .ti{font-size:12px;font-weight:600;margin-bottom:6px}
.lc .de{font-size:11px;color:#6b7280;line-height:1.6;white-space:pre-line}
.log{margin-top:12px;padding:12px;background:#f9fafb;border:1px solid #e5e7eb;border-radius:10px;font-family:'SF Mono','Fira Code',monospace;font-size:11px;color:#6b7280;line-height:1.7;max-height:220px;overflow-y:auto;white-space:pre-wrap;display:none}
.empty{padding:48px 20px;text-align:center;color:#9ca3af}
.empty .ic{font-size:32px;margin-bottom:10px}
.date-warn{color:#ef4444;font-size:11px;margin-top:8px;display:none}
.time-fixed{display:inline-block;background:#f3f4f6;border:1px solid #e5e7eb;padding:8px 12px;border-radius:8px;font-size:13px;color:#6b7280;font-family:'SF Mono',monospace;min-width:60px;text-align:center}
.manual-bar{display:flex;gap:10px;align-items:center;padding:14px 18px;background:#f9fafb;border:1px solid #e5e7eb;border-radius:12px;margin-bottom:14px;flex-wrap:wrap}
.manual-bar label{font-size:12px;color:#6b7280;font-weight:500}
.manual-bar input[type="number"]{width:80px;padding:6px 10px;font-size:13px}
.ck{width:16px;height:16px;accent-color:#10b981;cursor:pointer}
.price-in{width:110px;padding:6px 8px;border:1px solid #d1d5db;border-radius:6px;font-size:12px;font-family:inherit;text-align:right;background:#fff;outline:none;transition:border .15s}
.price-in:focus{border-color:#10b981;box-shadow:0 0 0 2px #10b98122}
.price-in.changed{border-color:#f59e0b;background:#fffbeb}
.price-in.error{border-color:#ef4444;background:#fef2f2}
.sel-count{font-size:12px;color:#059669;font-weight:600;background:#ecfdf5;padding:4px 10px;border-radius:8px}
#manual-section{display:none}
.search-box{padding:8px 12px;border:1px solid #d1d5db;border-radius:8px;font-size:13px;font-family:inherit;outline:none;width:200px;transition:border .15s}
.search-box:focus{border-color:#10b981}
.policy-info{font-size:11px;color:#6b7280;margin-top:8px;line-height:1.6}
.pol-del{color:#ef4444;cursor:pointer;font-size:11px;margin-left:6px}
.pol-del:hover{text-decoration:underline}
/* overlay alert */
.overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.4);display:flex;align-items:center;justify-content:center;z-index:9999;opacity:0;pointer-events:none;transition:opacity .2s}
.overlay.show{opacity:1;pointer-events:auto}
.alert-box{background:#fff;border-radius:16px;padding:32px 28px;max-width:420px;width:90%;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,.15);transform:translateY(10px);transition:transform .2s}
.overlay.show .alert-box{transform:translateY(0)}
.alert-ic{font-size:48px;margin-bottom:12px}
.alert-title{font-size:18px;font-weight:700;margin-bottom:8px}
.alert-desc{font-size:13px;color:#6b7280;line-height:1.7;margin-bottom:20px}
.alert-btn{padding:10px 32px;border-radius:10px;font-size:14px;font-family:inherit;font-weight:600;cursor:pointer;border:none;transition:all .15s}
@media(max-width:768px){.stats{grid-template-columns:repeat(3,1fr)}.logic{grid-template-columns:repeat(2,1fr)}.upload-grid,.upload-grid.single{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
<div class="fade-up" style="margin-bottom:32px"><div style="display:flex;align-items:center;gap:14px">
<div style="width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,#10b981,#059669);display:flex;align-items:center;justify-content:center;font-size:19px;color:#fff;box-shadow:0 4px 14px #10b98133">âš¡</div>
<div><h1 style="font-size:21px;font-weight:700;letter-spacing:-.6px;color:#111827">í”„ë¡œëª¨ì…˜ ìë™ ì„¸íŒ… <span style="font-size:13px;color:#9ca3af;font-weight:400;margin-left:6px">v6.0</span></h1>
<p style="font-size:12px;color:#9ca3af;margin-top:2px">ë„¤ì´ë²„ ë¸Œëœë“œìŠ¤í† ì–´ Â· ê°€ê²© ì •ì±… ê´€ë¦¬ Â· ì›ë³¸ ì–‘ì‹ 100% ìœ ì§€</p></div></div></div>

<div class="stats fade-up d1">
<div class="stat"><div class="stat-l">ì œì•ˆ</div><div class="stat-v" style="color:#9ca3af" id="s-prop">-</div></div>
<div class="stat"><div class="stat-l" id="s-conf-label">í™•ì •</div><div class="stat-v" style="color:#9ca3af" id="s-conf">-</div></div>
<div class="stat"><div class="stat-l">ì²˜ë¦¬</div><div class="stat-v" style="color:#10b981" id="s-match">-</div></div>
<div class="stat"><div class="stat-l">ì¶©ëŒ+ê²½ê³ </div><div class="stat-v" style="color:#d1d5db" id="s-issue">-</div></div>
<div class="stat"><div class="stat-l">í‰ê· í• ì¸</div><div class="stat-v" style="color:#d97706;font-size:22px" id="s-rate">-</div></div>
</div>

<!-- ê°€ê²© ì •ì±… -->
<div class="card fade-up d2"><div class="card-body">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
<div class="card-title" style="margin-bottom:0">ğŸ’° ê°€ê²© ì •ì±… <span id="pol-count" style="font-size:11px;color:#9ca3af;font-weight:400;margin-left:6px"></span></div>
<div style="display:flex;gap:8px">
<button class="btn-s" onclick="exportPolicy()">ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
<button class="btn-s" onclick="clearPolicy()" style="color:#ef4444;border-color:#fca5a5">ğŸ—‘ï¸ ì´ˆê¸°í™”</button>
</div>
</div>
<div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:12px">
<input type="text" id="gs-url" placeholder="êµ¬ê¸€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ URL ë¶™ì—¬ë„£ê¸° (ì£¼ì†Œì°½ URL ê·¸ëŒ€ë¡œ)" style="flex:1;min-width:300px;padding:10px 14px;border:1px solid #d1d5db;border-radius:10px;font-size:13px;font-family:inherit;outline:none;transition:border .2s" onfocus="this.style.borderColor='#6366f1'" onblur="this.style.borderColor='#d1d5db'">
<button class="btn-s" onclick="syncGoogleSheet()" id="btn-sync" style="background:#eef2ff;border-color:#6366f1;color:#4f46e5;font-weight:600;padding:10px 18px">ğŸ”„ ë™ê¸°í™”</button>
</div>
<div class="policy-info" id="gs-status">êµ¬ê¸€ì‹œíŠ¸ ê³µìœ  â†’ "ë§í¬ê°€ ìˆëŠ” ëª¨ë“  ì‚¬ìš©ì(ë·°ì–´)" ì„¤ì • í›„ ì£¼ì†Œì°½ URLì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”</div>
<div style="max-height:200px;overflow-y:auto;margin-top:10px" id="pol-tbl"></div>
</div></div>

<!-- í• ì¸ ê¸°ê°„ -->
<div class="card fade-up d2"><div class="card-body">
<div class="card-title" style="margin-bottom:16px">ğŸ“… í• ì¸ ê¸°ê°„ <span style="font-size:11px;color:#9ca3af;font-weight:400;margin-left:8px">ì‹œê°„: 00:00 ~ 23:59 ê³ ì •</span></div>
<div style="display:flex;gap:14px;align-items:flex-end;flex-wrap:wrap">
<div style="display:flex;flex-direction:column;gap:5px"><label style="font-size:11px;color:#9ca3af;font-weight:500">ì‹œì‘ì¼</label><div style="display:flex;gap:6px"><input type="date" id="sd"><span class="time-fixed">00:00</span></div></div>
<div style="color:#d1d5db;font-size:18px;padding-bottom:10px">â†’</div>
<div style="display:flex;flex-direction:column;gap:5px"><label style="font-size:11px;color:#9ca3af;font-weight:500">ì¢…ë£Œì¼</label><div style="display:flex;gap:6px"><input type="date" id="ed"><span class="time-fixed">23:59</span></div></div>
</div>
<div class="date-warn" id="date-warn">âš ï¸ ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”</div>
<div id="preview" style="margin-top:10px;padding:10px 14px;background:#f9fafb;border-radius:10px;border:1px solid #e5e7eb;font-family:'SF Mono',monospace;font-size:12px;color:#6b7280;line-height:1.7"></div>
</div></div>

<!-- íŒŒì¼ ì—…ë¡œë“œ -->
<div class="card fade-up d3"><div class="card-body">
<div class="card-title">ğŸ“¤ íŒŒì¼ ì—…ë¡œë“œ</div>
<div class="mode-toggle">
<button class="mode-btn on" id="mode-naver" onclick="setMode('naver')">ë„¤ì´ë²„ í–‰ì‚¬ (3íŒŒì¼)</button>
<button class="mode-btn" id="mode-internal" onclick="setMode('internal')">ë‚´ë¶€ í”„ë¡œëª¨ì…˜ (2íŒŒì¼)</button>
<button class="mode-btn" id="mode-manual" onclick="setMode('manual')">ìˆ˜ë™ ì„¸íŒ… (1íŒŒì¼)</button>
<button class="mode-btn" id="mode-check" onclick="setMode('check')">ğŸ” í˜„í™© ì²´í¬</button>
</div>
<div class="upload-grid" id="upload-grid">
<div class="uz" id="uz-proposal" onclick="document.getElementById('fi-proposal').click()" ondragover="event.preventDefault();this.classList.add('over')" ondragleave="this.classList.remove('over')" ondrop="event.preventDefault();this.classList.remove('over');setFile('proposal',event.dataTransfer.files[0])"><span class="rm" onclick="event.stopPropagation();removeFile('proposal')">Ã—</span><div class="num">â‘ </div><div class="lb">í–‰ì‚¬ ì œì•ˆ íŒŒì¼</div><div class="fn" id="fn-proposal">.xlsx ì—…ë¡œë“œ</div><input type="file" id="fi-proposal" accept=".xlsx,.xls,.csv" style="display:none" onchange="setFile('proposal',this.files[0])"></div>
<div class="uz" id="uz-confirmed" onclick="document.getElementById('fi-confirmed').click()" ondragover="event.preventDefault();this.classList.add('over')" ondragleave="this.classList.remove('over')" ondrop="event.preventDefault();this.classList.remove('over');setFile('confirmed',event.dataTransfer.files[0])"><span class="rm" onclick="event.stopPropagation();removeFile('confirmed')">Ã—</span><div class="num">â‘¡</div><div class="lb">í–‰ì‚¬ í™•ì • íŒŒì¼</div><div class="fn" id="fn-confirmed">.xlsx ì—…ë¡œë“œ</div><input type="file" id="fi-confirmed" accept=".xlsx,.xls,.csv" style="display:none" onchange="setFile('confirmed',this.files[0])"></div>
<div class="uz" id="uz-template" onclick="document.getElementById('fi-template').click()" ondragover="event.preventDefault();this.classList.add('over')" ondragleave="this.classList.remove('over')" ondrop="event.preventDefault();this.classList.remove('over');setFile('template',event.dataTransfer.files[0])"><span class="rm" onclick="event.stopPropagation();removeFile('template')">Ã—</span><div class="num">â‘¢</div><div class="lb">ì¼ê´„ìˆ˜ì •ì–‘ì‹</div><div class="fn" id="fn-template">.xlsx ì—…ë¡œë“œ</div><input type="file" id="fi-template" accept=".xlsx,.xls,.csv" style="display:none" onchange="setFile('template',this.files[0])"></div>
</div>
<div style="margin-top:14px;display:flex;gap:10px;align-items:center" id="auto-buttons">
<button class="btn btn-p" id="btn-go" onclick="run()" disabled>âš¡ ìë™ ì„¸íŒ… ì‹¤í–‰</button>
<span id="status" style="font-size:12px;color:#9ca3af"></span>
</div>
<div style="margin-top:14px;display:none;gap:10px;align-items:center" id="check-buttons">
<button class="btn btn-p" id="btn-check" onclick="runCheck()" disabled style="background:linear-gradient(135deg,#6366f1,#4f46e5);box-shadow:0 4px 14px #6366f133">ğŸ” í˜„í™© ì²´í¬ ì‹¤í–‰</button>
<span id="check-status" style="font-size:12px;color:#9ca3af"></span>
</div>
<div class="log" id="log"></div>
</div></div>

<!-- ìˆ˜ë™ ì„¸íŒ… -->
<div class="card fade-up" id="manual-section" style="display:none">
<div class="card-body">
<div class="card-title">ğŸ“‹ ìƒí’ˆ ì„ íƒ ë° ê°€ê²© ì„¤ì •</div>
<div class="manual-bar">
<input type="text" class="search-box" id="m-search" placeholder="ğŸ” ìƒí’ˆë²ˆí˜¸/ìƒí’ˆëª… ê²€ìƒ‰" oninput="renderManual()">
<div style="flex:1"></div>
<button class="btn-t1" onclick="applyTier(1)">1ì°¨ í–‰ì‚¬ê°€ ì ìš©</button>
<button class="btn-t2" onclick="applyTier(2)">2ì°¨ í–‰ì‚¬ê°€ ì ìš©</button>
<div style="width:1px;height:20px;background:#e5e7eb"></div>
<label>í• ì¸ìœ¨</label><input type="number" id="m-rate" min="1" max="99" placeholder="%" style="width:65px">
<button class="btn-s" onclick="applyRate()">ì ìš©</button>
<div style="width:1px;height:20px;background:#e5e7eb"></div>
<button class="btn-s" onclick="selectAll(true)">ì „ì²´ ì„ íƒ</button>
<button class="btn-s" onclick="selectAll(false)">ì „ì²´ í•´ì œ</button>
<span class="sel-count" id="m-sel-count">0ê°œ ì„ íƒ</span>
</div>
<div id="m-tbl" style="max-height:500px;overflow-y:auto"></div>
</div>
<div class="t-foot">
<span style="color:#9ca3af">ìµœì¢…í˜œíƒê°€ ì…ë ¥ í›„ ì„ íƒ ìƒí’ˆë§Œ ì²˜ë¦¬</span>
<div style="display:flex;gap:10px;align-items:center">
<span style="color:#9ca3af">ì˜ˆì•½í• ì¸ í•©ê³„: <span style="color:#059669;font-weight:700" id="m-rsv-total">0ì›</span></span>
<button class="btn btn-p" id="btn-manual-go" onclick="runManual()" disabled>âš¡ ìˆ˜ë™ ì„¸íŒ… ì‹¤í–‰</button>
</div></div></div>

<!-- í˜„í™© ì²´í¬ ê²°ê³¼ -->
<div class="card fade-up" id="check-section" style="display:none">
<div class="card-body">
<div class="card-title">ğŸ” í˜„í™© ì²´í¬ ê²°ê³¼</div>
<div id="check-summary" style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:14px"></div>
<div id="check-tbl" style="max-height:500px;overflow-y:auto"></div>
</div>
<div class="t-foot"><span id="check-foot" style="color:#9ca3af"></span><button class="btn-s" id="btn-check-dl" onclick="exportCheckResult()" style="display:none">ğŸ“¥ ì´ìƒ í•­ëª© ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button></div>
</div>

<!-- ì¶©ëŒ ë¡œì§ -->
<div class="card fade-up d4" id="logic-card"><div class="card-body">
<div class="card-title">ğŸ›¡ï¸ ì¶©ëŒ ì²˜ë¦¬ ë¡œì§</div>
<div class="logic">
<div class="lc" style="background:#ecfdf5;border:1px solid #10b98120"><div class="ic">âœ…</div><div class="ti" style="color:#059669">ì‹ ê·œ ì„¸íŒ…</div><div class="de">ê¸°ì¡´ ì˜ˆì•½í• ì¸ ì—†ìŒ
ë˜ëŠ” ê¸°ê°„ ì•ˆê²¹ì¹¨</div></div>
<div class="lc" style="background:#fffbeb;border:1px solid #f59e0b20"><div class="ic">ğŸ”„</div><div class="ti" style="color:#d97706">ê¸°ê°„ ì—°ì¥</div><div class="de">ê¸ˆì•¡ ë™ì¼ + ê¸°ê°„ ê²¹ì¹¨
ì‹œì‘ì¼ ìœ ì§€, ì¢…ë£Œì¼ ë³€ê²½</div></div>
<div class="lc" style="background:#fef2f2;border:1px solid #ef444420"><div class="ic">âš ï¸</div><div class="ti" style="color:#dc2626">ì¶©ëŒ</div><div class="de">ê¸ˆì•¡ ë‹¤ë¦„ + ê¸°ê°„ ê²¹ì¹¨
ì• í–‰ì‚¬ ì¢…ë£Œ í›„ ë³„ë„ ì²˜ë¦¬</div></div>
<div class="lc" style="background:#fff7ed;border:1px solid #f9731620"><div class="ic">ğŸ’¡</div><div class="ti" style="color:#ea580c">ê²½ê³ </div><div class="de">ê°€ê²© ë¶ˆì¼ì¹˜ ë“±
íŒë§¤ê°€ â‰¤ í–‰ì‚¬ê°€</div></div>
</div></div></div>

<!-- ê²°ê³¼ -->
<div class="card fade-up d5" id="res" style="display:none">
<div class="tabs" id="tabs"></div><div id="tbl"></div>
<div class="t-foot"><span style="color:#9ca3af">ì˜ˆì•½í• ì¸ í•©ê³„: <span style="color:#059669;font-weight:700" id="t-rsv">0ì›</span></span></div>
</div>
</div>

<!-- ì•Œë¦¼ ì˜¤ë²„ë ˆì´ -->
<div class="overlay" id="alert-overlay" onclick="if(event.target===this)closeAlert()">
<div class="alert-box">
<div class="alert-ic" id="alert-ic"></div>
<div class="alert-title" id="alert-title"></div>
<div class="alert-desc" id="alert-desc"></div>
<button class="alert-btn" id="alert-btn" onclick="closeAlert()">í™•ì¸</button>
</div>
</div>

<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script>
// ===== ì „ì—­ =====
var files={},R={updated:[],extended:[],conflicts:[],warnings:[]},activeTab='all',mode='naver';
var manualProducts=[],manualCols={},manualWb=null,manualBuf=null;
var pricePolicy={}; // {ìƒí’ˆë²ˆí˜¸: {name, regular, t1, t2}}

function S(v){return v==null?'':String(v)}
function fmt(n){return n.toLocaleString('ko-KR')}
function fmtD(d){return d?String(d.getMonth()+1).padStart(2,'0')+'/'+String(d.getDate()).padStart(2,'0'):'?'}
function fmtFull(d){return d?d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0')+' '+String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0'):''}
function norm(v){return S(v).replace(/[\s\n\r]/g,'')}
function log(m){var e=document.getElementById('log');e.style.display='block';e.textContent+=m+'\n';e.scrollTop=e.scrollHeight}

// ===== ì•Œë¦¼ =====
function showAlert(icon,title,desc,btnText,btnColor){
  document.getElementById('alert-ic').textContent=icon;
  document.getElementById('alert-title').textContent=title;
  document.getElementById('alert-desc').innerHTML=desc;
  var b=document.getElementById('alert-btn');b.textContent=btnText||'í™•ì¸';
  b.style.background=btnColor||'linear-gradient(135deg,#10b981,#059669)';b.style.color='#fff';
  document.getElementById('alert-overlay').classList.add('show');
}
function closeAlert(){document.getElementById('alert-overlay').classList.remove('show')}

// ===== ê°€ê²© ì •ì±… localStorage =====
function loadPolicy(){
  try{var d=localStorage.getItem('promo_price_policy');if(d)pricePolicy=JSON.parse(d)}catch(e){}
  try{var u=localStorage.getItem('promo_gs_url');if(u)document.getElementById('gs-url').value=u}catch(e){}
  renderPolicy();
  // ë§ˆì§€ë§‰ ë™ê¸°í™” ì‹œê°„ í‘œì‹œ
  try{var t=localStorage.getItem('promo_gs_sync');if(t)document.getElementById('gs-status').innerHTML='âœ… ë§ˆì§€ë§‰ ë™ê¸°í™”: '+t+' Â· <span style="color:#6366f1;cursor:pointer" onclick="syncGoogleSheet()">ë‹¤ì‹œ ë™ê¸°í™”</span>'}catch(e){}
}
function savePolicy(){
  try{localStorage.setItem('promo_price_policy',JSON.stringify(pricePolicy))}catch(e){}
  renderPolicy();
}
function clearPolicy(){
  if(!confirm('ê°€ê²© ì •ì±…ê³¼ êµ¬ê¸€ì‹œíŠ¸ URLì„ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;
  pricePolicy={};document.getElementById('gs-url').value='';
  try{localStorage.removeItem('promo_price_policy');localStorage.removeItem('promo_gs_url');localStorage.removeItem('promo_gs_sync')}catch(e){}
  document.getElementById('gs-status').textContent='êµ¬ê¸€ì‹œíŠ¸ ê³µìœ  â†’ "ë§í¬ê°€ ìˆëŠ” ëª¨ë“  ì‚¬ìš©ì(ë·°ì–´)" ì„¤ì • í›„ ì£¼ì†Œì°½ URLì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”';
  renderPolicy();
}
function deletePolicy(pn){delete pricePolicy[pn];savePolicy();if(manualProducts.length)renderManual()}
function renderPolicy(){
  var keys=Object.keys(pricePolicy);
  document.getElementById('pol-count').textContent=keys.length?keys.length+'ê°œ ìƒí’ˆ ë“±ë¡':'ë¯¸ë“±ë¡';
  var con=document.getElementById('pol-tbl');
  if(!keys.length){con.innerHTML='<div style="padding:20px;text-align:center;color:#9ca3af;font-size:12px">ë“±ë¡ëœ ê°€ê²© ì •ì±…ì´ ì—†ìŠµë‹ˆë‹¤<br>êµ¬ê¸€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ë¥¼ ì—°ê²°í•´ì£¼ì„¸ìš”</div>';return}
  var h='<table><thead><tr><th>ìƒí’ˆë²ˆí˜¸</th><th>ìƒí’ˆëª…</th><th class="r">ìƒì‹œê°€</th><th class="r">1ì°¨ í–‰ì‚¬ê°€</th><th class="r">2ì°¨ í–‰ì‚¬ê°€</th><th></th></tr></thead><tbody>';
  keys.forEach(function(pn){var p=pricePolicy[pn];
    h+='<tr class="dr"><td class="mono">'+pn+'</td><td class="name" title="'+S(p.name)+'">'+S(p.name)+'</td>';
    h+='<td class="r">'+(p.regular?fmt(p.regular):'<span style="color:#d1d5db">-</span>')+'</td>';
    h+='<td class="r"><span class="badge b-t1">'+fmt(p.t1)+'</span></td>';
    h+='<td class="r"><span class="badge b-t2">'+fmt(p.t2)+'</span></td>';
    h+='<td><span class="pol-del" onclick="deletePolicy(\''+pn+'\')">ì‚­ì œ</span></td></tr>'});
  h+='</tbody></table>';con.innerHTML=h;
}
function extractSheetId(url){
  url=url.trim();
  // /d/e/ í˜•ì‹ (pub URL) â†’ ì‚¬ìš© ë¶ˆê°€, ì¼ë°˜ URL í•„ìš”
  if(url.match(/\/d\/e\//))return null;
  // ì¼ë°˜ URL: /spreadsheets/d/SHEET_ID/
  var m=url.match(/\/spreadsheets\/d\/([a-zA-Z0-9_-]+)/);
  return m?m[1]:null;
}
function syncGoogleSheet(){
  var rawUrl=document.getElementById('gs-url').value.trim();
  if(!rawUrl){showAlert('âš ï¸','URL ì—†ìŒ','êµ¬ê¸€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.','í™•ì¸','#f59e0b');return}
  var sheetId=extractSheetId(rawUrl);
  if(!sheetId){
    showAlert('âš ï¸','URL í˜•ì‹ í™•ì¸','êµ¬ê¸€ì‹œíŠ¸ ì£¼ì†Œì°½ì˜ URLì„ ê·¸ëŒ€ë¡œ ë¶™ì—¬ë„£ì–´ì£¼ì„¸ìš”.<br><br>âœ… ì˜¬ë°”ë¥¸ ì˜ˆì‹œ:<br><span style="font-size:11px;word-break:break-all">https://docs.google.com/spreadsheets/d/<strong>ì‹œíŠ¸ID</strong>/edit...</span><br><br>âŒ "ì›¹ì— ê²Œì‹œ" URLì€ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.','í™•ì¸','#f59e0b');
    return;
  }
  try{localStorage.setItem('promo_gs_url',rawUrl)}catch(e){}
  var btn=document.getElementById('btn-sync');btn.textContent='â³ ë™ê¸°í™” ì¤‘...';btn.disabled=true;
  var stEl=document.getElementById('gs-status');stEl.innerHTML='<span style="color:#6366f1">â³ êµ¬ê¸€ì‹œíŠ¸ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...</span>';
  // JSONP: script íƒœê·¸ë¡œ CORS ìš°íšŒ
  var cbName='_gsCallback_'+Date.now();
  var gvizUrl='https://docs.google.com/spreadsheets/d/'+sheetId+'/gviz/tq?tqx=responseHandler:'+cbName;
  var script=document.createElement('script');
  var timeout=setTimeout(function(){
    cleanup();
    stEl.innerHTML='<span style="color:#ef4444">âŒ ì‹œê°„ ì´ˆê³¼ â€” ì‹œíŠ¸ê°€ ê³µìœ  ì„¤ì •(ë§í¬ê°€ ìˆëŠ” ëª¨ë“  ì‚¬ìš©ì)ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”</span>';
    showAlert('âŒ','ë™ê¸°í™” ì‹¤íŒ¨','ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.<br><br>í™•ì¸ì‚¬í•­:<br>â€¢ êµ¬ê¸€ì‹œíŠ¸ ê³µìœ  â†’ "ë§í¬ê°€ ìˆëŠ” ëª¨ë“  ì‚¬ìš©ì" ì„¤ì •<br>â€¢ URLì´ ì˜¬ë°”ë¥¸ì§€','í™•ì¸','#ef4444');
  },10000);
  function cleanup(){clearTimeout(timeout);delete window[cbName];if(script.parentNode)script.parentNode.removeChild(script);btn.textContent='ğŸ”„ ë™ê¸°í™”';btn.disabled=false}
  window[cbName]=function(response){
    cleanup();
    try{
      if(response.status==='error'){throw new Error(response.errors.map(function(e){return e.message}).join(', '))}
      var tbl=response.table;var count=0;var newPolicy={};
      for(var r=0;r<tbl.rows.length;r++){
        var cells=tbl.rows[r].c;if(!cells)continue;
        var pn=null,name='',prices=[];
        for(var c=0;c<cells.length;c++){
          var cell=cells[c];if(!cell||cell.v==null)continue;
          var v=cell.v;var sv=String(v).trim().split('.')[0];
          if(/^\d{8,15}$/.test(sv)&&sv!=='1234567890'&&!pn){pn=sv;continue}
          if(typeof v==='string'&&v.length>2&&pn&&!name){name=v;continue}
          if(typeof v==='number'&&v>=100&&v<=10000000)prices.push(Math.round(v));
        }
        if(!pn||prices.length<2)continue;
        var regular=0,t1=0,t2=0;
        if(prices.length>=3){regular=prices[0];t1=prices[1];t2=prices[2]}
        else{t1=prices[0];t2=prices[1]}
        // 1ì°¨ > 2ì°¨ ë³´ì¥
        if(t1<t2){var tmp=t1;t1=t2;t2=tmp}
        newPolicy[pn]={name:name,regular:regular,t1:t1,t2:t2};count++;
      }
      if(!count)throw new Error('ìƒí’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì‹œíŠ¸ í˜•ì‹(ìƒí’ˆë²ˆí˜¸/ìƒí’ˆëª…/1ì°¨ê°€/2ì°¨ê°€)ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
      pricePolicy=newPolicy;savePolicy();
      var now=new Date();var ts=now.getFullYear()+'-'+String(now.getMonth()+1).padStart(2,'0')+'-'+String(now.getDate()).padStart(2,'0')+' '+String(now.getHours()).padStart(2,'0')+':'+String(now.getMinutes()).padStart(2,'0');
      try{localStorage.setItem('promo_gs_sync',ts)}catch(e){}
      stEl.innerHTML='âœ… ë™ê¸°í™” ì™„ë£Œ: '+ts+' ('+count+'ê°œ) Â· <span style="color:#6366f1;cursor:pointer" onclick="syncGoogleSheet()">ë‹¤ì‹œ ë™ê¸°í™”</span>';
      showAlert('âœ…','ë™ê¸°í™” ì™„ë£Œ',count+'ê°œ ìƒí’ˆì˜ ê°€ê²© ì •ì±…ì„ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.','í™•ì¸');
      if(manualProducts.length)renderManual();
    }catch(err){
      stEl.innerHTML='<span style="color:#ef4444">âŒ '+err.message+'</span>';
      showAlert('âŒ','ë™ê¸°í™” ì‹¤íŒ¨',err.message,'í™•ì¸','#ef4444');
    }
  };
  script.onerror=function(){cleanup();stEl.innerHTML='<span style="color:#ef4444">âŒ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì‹¤íŒ¨</span>';showAlert('âŒ','ë™ê¸°í™” ì‹¤íŒ¨','êµ¬ê¸€ì‹œíŠ¸ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>ê³µìœ  ì„¤ì •ê³¼ URLì„ í™•ì¸í•´ì£¼ì„¸ìš”.','í™•ì¸','#ef4444')};
  script.src=gvizUrl;document.body.appendChild(script);
}
function exportPolicy(){
  var keys=Object.keys(pricePolicy);if(!keys.length){alert('ë“±ë¡ëœ ì •ì±…ì´ ì—†ìŠµë‹ˆë‹¤');return}
  var data=[['ìƒí’ˆë²ˆí˜¸','ìƒí’ˆëª…','ìƒì‹œê°€','1ì°¨ í–‰ì‚¬ê°€','2ì°¨ í–‰ì‚¬ê°€']];
  keys.forEach(function(pn){var p=pricePolicy[pn];data.push([pn,p.name||'',p.regular||'',p.t1,p.t2])});
  var ws=XLSX.utils.aoa_to_sheet(data);var wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'ê°€ê²©ì •ì±…');
  XLSX.writeFile(wb,'ê°€ê²©ì •ì±….xlsx');
}

// ===== SheetJS helpers =====
function fixSheetRef(ws){var maxR=0,maxC=0,cnt=0;for(var k of Object.keys(ws)){if(k[0]==='!')continue;var c=XLSX.utils.decode_cell(k);if(c.r>maxR)maxR=c.r;if(c.c>maxC)maxC=c.c;cnt++}var o=ws['!ref']||'';ws['!ref']=XLSX.utils.encode_range({s:{r:0,c:0},e:{r:maxR,c:maxC}});return{oldRef:o,newRef:ws['!ref'],rows:maxR+1,cols:maxC+1,cells:cnt}}
function xmlSetCell(doc,ns,rowNum,colLetter,value,type){var cellRef=colLetter+rowNum;var rows=doc.getElementsByTagNameNS(ns,'row');var rowEl=null;for(var i=0;i<rows.length;i++){if(rows[i].getAttribute('r')===String(rowNum)){rowEl=rows[i];break}}if(!rowEl)return false;var cells=rowEl.getElementsByTagNameNS(ns,'c');var cellEl=null;for(var i=0;i<cells.length;i++){if(cells[i].getAttribute('r')===cellRef){cellEl=cells[i];break}}if(!cellEl){cellEl=doc.createElementNS(ns,'c');cellEl.setAttribute('r',cellRef);rowEl.appendChild(cellEl)}var sty=cellEl.getAttribute('s');while(cellEl.firstChild)cellEl.removeChild(cellEl.firstChild);if(type==='n'){cellEl.removeAttribute('t');var v=doc.createElementNS(ns,'v');v.textContent=String(value);cellEl.appendChild(v)}else{cellEl.setAttribute('t','inlineStr');var is=doc.createElementNS(ns,'is');var t=doc.createElementNS(ns,'t');t.textContent=value;is.appendChild(t);cellEl.appendChild(is)}if(sty)cellEl.setAttribute('s',sty);return true}

// ===== ìŠ¤ë§ˆíŠ¸ íŒŒì„œ =====
var PN_RE=/^\d{8,15}$/,DUMMY=new Set(['1234567890','0000000000']);
var PRICE_KW=[['ìµœì¢…í˜œíƒê°€'],['ìµœëŒ€í˜œíƒê°€'],['ìµœëŒ€','í˜œíƒ'],['ì¦‰ì‹œí• ì¸ê°€'],['ì¦‰ì‹œ','í• ì¸ê°€'],['í• ì¸ê°€']];
function isPN(v){if(v==null)return false;var s=S(v).trim().split('.')[0];return PN_RE.test(s)&&!DUMMY.has(s)}
function cleanPN(v){return S(v).trim().split('.')[0]}
function isPrice(v){if(v==null)return false;try{return parseFloat(v)>=100&&parseFloat(v)<=10000000}catch(e){return false}}
function findBestPriceCol(data,pnRow,pnCol){for(var l=1;l<=10;l++){var hr=pnRow-l;if(hr<0)break;var row=data[hr];if(!row)continue;var t={};for(var c=0;c<row.length;c++){var v=row[c];if(v&&typeof v==='string')t[c]=v.replace(/\n/g,' ')}if(!Object.keys(t).length)continue;for(var kws of PRICE_KW){for(var ci in t){if(kws.every(function(k){return t[ci].includes(k)}))return{col:parseInt(ci),name:t[ci]}}}}var row=data[pnRow];if(!row)return null;var last=null;for(var c=pnCol+1;c<row.length;c++){if(isPrice(row[c]))last=c}return last!==null?{col:last,name:'(ìë™ê°ì§€)'}:null}
function smartExtract(wb){var products={};wb.SheetNames.forEach(function(sn){var ws=wb.Sheets[sn];var ref=fixSheetRef(ws);var data=XLSX.utils.sheet_to_json(ws,{header:1,raw:true,defval:null});log('  ['+sn+'] '+ref.oldRef+'->'+ref.newRef+' '+data.length+'í–‰');var pcs=[];for(var r=0;r<data.length;r++){var row=data[r];if(!row)continue;for(var c=0;c<row.length;c++){if(isPN(row[c]))pcs.push({r:r,c:c,pn:cleanPN(row[c])})}}if(!pcs.length){log('    -> ì—†ìŒ');return}log('    -> '+pcs.length+'ê°œ');var cache={};for(var pi=0;pi<pcs.length;pi++){var p=pcs[pi];var pc=null;for(var k in cache){var parts=k.split(',').map(Number);if(parts[1]===p.c&&Math.abs(p.r-parts[0])<15){pc=cache[k];break}}if(pc===null){var f=findBestPriceCol(data,p.r,p.c);if(f){pc=f.col;cache[p.r+','+p.c]=f.col;log('    R'+(p.r+1)+': ->C'+(f.col+1)+' ('+f.name+')')}}if(pc===null)continue;var pv=data[p.r][pc];if(!isPrice(pv))continue;var price=Math.round(parseFloat(pv));var name='';for(var nc=p.c+1;nc<data[p.r].length;nc++){var nv=data[p.r][nc];if(nv&&typeof nv==='string'&&nv.length>2&&!isPrice(nv)){name=nv;break}}if(!products[p.pn]||price<products[p.pn].price)products[p.pn]={price:price,name:name}}});log('  -> '+Object.keys(products).length+'ê°œ');return products}
function smartExtractConfirmed(wb){var confirmed={};wb.SheetNames.forEach(function(sn){var ws=wb.Sheets[sn];fixSheetRef(ws);var data=XLSX.utils.sheet_to_json(ws,{header:1,raw:true,defval:null});log('  ['+sn+'] '+data.length+'í–‰');for(var r=0;r<data.length;r++){var row=data[r];if(!row)continue;for(var c=0;c<row.length;c++){if(!isPN(row[c]))continue;var pn=cleanPN(row[c]);var price=null;var f=findBestPriceCol(data,r,c);if(f){var pv=row[f.col];if(isPrice(pv))price=Math.round(parseFloat(pv))}if(!confirmed[pn])confirmed[pn]={price:price};else if(price&&(!confirmed[pn].price||price<confirmed[pn].price))confirmed[pn]={price:price}}}log('    -> '+Object.keys(confirmed).length+'ê°œ')});return confirmed}

// ===== UI =====
function datesValid(){return document.getElementById('sd').value&&document.getElementById('ed').value}
function updP(){var sd=document.getElementById('sd').value,ed=document.getElementById('ed').value;var el=document.getElementById('preview');if(datesValid())el.innerHTML='<span style="color:#059669;font-weight:600">BG</span> <span style="color:#374151">'+sd+' 00:00 ~ '+ed+' 23:59</span>';else el.innerHTML='<span style="color:#9ca3af">ì‹œì‘ì¼/ì¢…ë£Œì¼ì„ ì„ íƒí•˜ë©´ ë¯¸ë¦¬ë³´ê¸°ê°€ í‘œì‹œë©ë‹ˆë‹¤</span>';document.getElementById('date-warn').style.display='none';checkReady();checkManualReady()}
document.addEventListener('change',updP);updP();

function setMode(m){mode=m;document.querySelectorAll('.mode-btn').forEach(function(b){b.classList.remove('on')});document.getElementById('mode-'+m).classList.add('on');var grid=document.getElementById('upload-grid');var uzP=document.getElementById('uz-proposal'),uzC=document.getElementById('uz-confirmed'),uzT=document.getElementById('uz-template');var ab=document.getElementById('auto-buttons');var cb=document.getElementById('check-buttons');var ms=document.getElementById('manual-section');var cs=document.getElementById('check-section');var lc=document.getElementById('logic-card');cs.style.display='none';cb.style.display='none';lc.style.display='block';if(m==='manual'){grid.className='upload-grid single';uzP.style.display='none';uzC.style.display='none';uzT.style.display='block';ab.style.display='none';ms.style.display=files.template?'block':'none'}else if(m==='check'){grid.className='upload-grid single';uzP.style.display='none';uzC.style.display='none';uzT.style.display='block';ab.style.display='none';cb.style.display='flex';ms.style.display='none';lc.style.display='none';checkCheckReady()}else{grid.className='upload-grid';uzP.style.display='block';uzT.style.display='block';ab.style.display='flex';ms.style.display='none';if(m==='internal'){uzC.style.display='block';uzC.style.opacity='.35';uzC.style.pointerEvents='none';if(!uzC.querySelector('.opt-badge')){var b=document.createElement('div');b.className='opt-badge';b.textContent='ì‚¬ìš© ì•ˆí•¨';uzC.appendChild(b)}}else{uzC.style.display='block';uzC.style.opacity='1';uzC.style.pointerEvents='auto';var b=uzC.querySelector('.opt-badge');if(b)b.remove()}}checkReady()}
function setFile(t,f){if(!f)return;files[t]=f;var z=document.getElementById('uz-'+t);z.classList.add('done');z.querySelector('.num').textContent='âœ“';document.getElementById('fn-'+t).textContent=f.name;
  if(t==='template'){var m=f.name.match(/(\d{4})(\d{2})(\d{2})/);if(m){var fd=m[1]+'-'+m[2]+'-'+m[3];var now=new Date();var td=now.getFullYear()+'-'+String(now.getMonth()+1).padStart(2,'0')+'-'+String(now.getDate()).padStart(2,'0');if(fd!==td){var ok=confirm('âš ï¸ ì¼ê´„ìˆ˜ì •ì–‘ì‹ ë‚ ì§œ ê²½ê³ \n\níŒŒì¼ ë‚ ì§œ: '+fd+'\nì˜¤ëŠ˜ ë‚ ì§œ: '+td+'\n\nìµœì‹  íŒŒì¼ì´ ì•„ë‹ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\nì˜ˆì „ ì–‘ì‹ì„ ì—…ë¡œë“œí•˜ë©´ ìƒí’ˆ ì •ë³´ê°€ ë®ì–´ì”Œì›Œì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\nê·¸ë˜ë„ ê³„ì† ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');if(!ok){removeFile(t);return}}}else{var ok=confirm('âš ï¸ ì¼ê´„ìˆ˜ì •ì–‘ì‹ íŒŒì¼ëª… ê²½ê³ \n\níŒŒì¼ëª…ì—ì„œ ë‚ ì§œë¥¼ ì¸ì‹í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n('+f.name+')\n\në„¤ì´ë²„ì—ì„œ ì˜¤ëŠ˜ ë‹¤ìš´ë°›ì€ ìµœì‹  íŒŒì¼ì´ ë§ìŠµë‹ˆê¹Œ?');if(!ok){removeFile(t);return}}if(mode==='manual')loadManualProducts();if(mode==='check')checkCheckReady()}checkReady()}
function removeFile(t){delete files[t];var z=document.getElementById('uz-'+t);z.classList.remove('done');z.querySelector('.num').textContent={proposal:'â‘ ',confirmed:'â‘¡',template:'â‘¢'}[t];document.getElementById('fn-'+t).textContent='.xlsx ì—…ë¡œë“œ';document.getElementById('fi-'+t).value='';if(t==='template'&&mode==='manual'){manualProducts=[];document.getElementById('manual-section').style.display='none'}checkReady()}
function checkReady(){if(mode==='manual')return;var fOk=mode==='naver'?files.proposal&&files.confirmed&&files.template:files.proposal&&files.template;document.getElementById('btn-go').disabled=!(fOk&&datesValid());var n=Object.keys(files).filter(function(k){return mode==='naver'||k!=='confirmed'}).length;var tot=mode==='naver'?3:2;var msg='';if(!fOk&&!datesValid())msg=Math.min(n,tot)+'/'+tot+' íŒŒì¼ Â· ê¸°ê°„ ë¯¸ì„¤ì •';else if(!fOk)msg=Math.min(n,tot)+'/'+tot+' íŒŒì¼';else if(!datesValid())msg='í• ì¸ ê¸°ê°„ì„ ì„¤ì •í•´ì£¼ì„¸ìš”';else msg='ì¤€ë¹„ ì™„ë£Œ âœ“';document.getElementById('status').textContent=msg}
function readXL(f){return new Promise(function(r){var x=new FileReader();x.onload=function(e){r(XLSX.read(e.target.result,{type:'array'}))};x.readAsArrayBuffer(f)})}
function readBuf(f){return f.arrayBuffer()}
function parsePeriod(v){if(!v||typeof v!=='string')return[null,null];var l=v.trim().replace(/\r\n/g,'\n').split('\n').map(function(x){return x.trim()}).filter(Boolean);if(l.length!==2)return[null,null];try{return[new Date(l[0].replace(' ','T')),new Date(l[1].replace(' ','T'))]}catch(e){return[null,null]}}
function overlap(a,b,c,d){return a<=d&&c<=b}

// ===== ìˆ˜ë™: ìƒí’ˆ ë¡œë“œ =====
async function loadManualProducts(){var lg=document.getElementById('log');lg.textContent='';lg.style.display='block';log('ğŸ“„ ì¼ê´„ìˆ˜ì •ì–‘ì‹ ë¡œë“œ (ìˆ˜ë™)...');manualBuf=await files.template.arrayBuffer();manualWb=XLSX.read(manualBuf,{type:'array'});var ws=manualWb.Sheets[manualWb.SheetNames[0]];var ref=fixSheetRef(ws);log('  !ref: '+ref.oldRef+' -> '+ref.newRef);var data=XLSX.utils.sheet_to_json(ws,{header:1,raw:true,defval:null});log('  '+data.length+'í–‰');var headerRow=-1;for(var ri=0;ri<Math.min(10,data.length);ri++){var row=data[ri];if(!row)continue;for(var c=0;c<row.length;c++){if(norm(row[c])==='ìƒí’ˆë²ˆí˜¸'){headerRow=ri;break}}if(headerRow>=0)break}if(headerRow<0){log('âŒ í—¤ë” ì—†ìŒ');return}var colA=-1,colD=-1,colF=-1,colBA=-1,colBE=-1,colBF=-1,colBG=-1;var hrow=data[headerRow];for(var c=0;c<hrow.length;c++){var n=norm(hrow[c]);if(n==='ìƒí’ˆë²ˆí˜¸')colA=c;if(n==='ìƒí’ˆëª…')colD=c;if(n==='íŒë§¤ê°€')colF=c;if(n.includes('ì¦‰ì‹œí• ì¸ê°’')&&!n.includes('ëª¨ë°”ì¼'))colBA=c;if(n==='ì˜ˆì•½í• ì¸ê°’')colBE=c;if(n==='ì˜ˆì•½í• ì¸ë‹¨ìœ„')colBF=c;if(n==='ì˜ˆì•½í• ì¸ê¸°ê°„')colBG=c}if(colBG<0)colBG=colBE+2;if(colBF<0)colBF=colBE+1;manualCols={colA:colA,colD:colD,colF:colF,colBA:colBA,colBE:colBE,colBF:colBF,colBG:colBG};log('  ì»¬ëŸ¼: BE='+colBE+' BF='+colBF+' BG='+colBG);manualProducts=[];for(var i=headerRow+1;i<data.length;i++){var row=data[i];if(!row)continue;var raw=row[colA];if(!isPN(raw))continue;var pn=cleanPN(raw),nm=S(row[colD]),pr=Math.round(parseFloat(row[colF])||0);var inst=colBA>=0?Math.round(parseFloat(row[colBA])||0):0;var existBE=row[colBE]!=null?Math.round(parseFloat(row[colBE])||0):0;var existBG=row[colBG]!=null?S(row[colBG]):'';manualProducts.push({pn:pn,name:nm,price:pr,instant:inst,existBE:existBE,existBG:existBG,rowIdx:i,excelRow:i+1,selected:false,targetPrice:null})}log('  -> '+manualProducts.length+'ê°œ');document.getElementById('manual-section').style.display='block';renderManual()}

// ===== ìˆ˜ë™: í–‰ì‚¬ê°€ ì ìš© =====
function applyTier(tier){
  var keys=Object.keys(pricePolicy);
  if(!keys.length){showAlert('âš ï¸','ê°€ê²© ì •ì±… ì—†ìŒ','ê°€ê²© ì •ì±…ì´ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\në¨¼ì € ì—‘ì…€ íŒŒì¼ë¡œ ê°€ê²© ì •ì±…ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.','í™•ì¸','#f59e0b');return}
  var applied=0,notFound=[];
  manualProducts.forEach(function(p){
    if(!p.selected)return;
    var pol=pricePolicy[p.pn];
    if(!pol){notFound.push(p.pn);return}
    p.targetPrice=tier===1?pol.t1:pol.t2;applied++;
  });
  if(!manualProducts.some(function(p){return p.selected})){showAlert('âš ï¸','ì„ íƒ ìƒí’ˆ ì—†ìŒ','ë¨¼ì € í–‰ì‚¬ê°€ë¥¼ ì ìš©í•  ìƒí’ˆì„ ì„ íƒí•´ì£¼ì„¸ìš”.','í™•ì¸','#f59e0b');return}
  var msg=applied+'ê°œ ìƒí’ˆì— '+tier+'ì°¨ í–‰ì‚¬ê°€ ì ìš©';
  if(notFound.length)msg+='<br><br><span style="color:#ef4444">âš ï¸ '+notFound.length+'ê°œ ìƒí’ˆì€ ê°€ê²© ì •ì±…ì— ë¯¸ë“±ë¡:</span><br><span style="font-size:11px;color:#6b7280">'+notFound.join(', ')+'</span>';
  showAlert('âœ…',tier+'ì°¨ í–‰ì‚¬ê°€ ì ìš© ì™„ë£Œ',msg,'í™•ì¸');
  renderManual();
}
function applyRate(){var rate=parseFloat(document.getElementById('m-rate').value);if(!rate||rate<=0||rate>=100)return;manualProducts.forEach(function(p){if(p.selected)p.targetPrice=Math.round(p.price*(1-rate/100))});renderManual()}

// ===== ìˆ˜ë™: í…Œì´ë¸” =====
function renderManual(){
  var q=(document.getElementById('m-search').value||'').toLowerCase();
  var filtered=q?manualProducts.filter(function(p){return p.pn.includes(q)||p.name.toLowerCase().includes(q)}):manualProducts;
  var con=document.getElementById('m-tbl');
  var h='<table><thead><tr><th style="width:30px"><input type="checkbox" class="ck" onchange="toggleAllVisible(this.checked)"></th><th>ìƒí’ˆë²ˆí˜¸</th><th>ìƒí’ˆëª…</th><th class="r">íŒë§¤ê°€</th><th class="r">ì¦‰ì‹œí• ì¸</th><th class="r">ì¦‰ì‹œí• ì¸ê°€</th><th class="r">ê¸°ì¡´ ì˜ˆì•½í• ì¸</th><th class="r">í˜„ì¬ íŒë§¤ê°€</th><th style="width:130px">ìµœì¢…í˜œíƒê°€ ì…ë ¥</th><th class="r">ì˜ˆì•½í• ì¸</th></tr></thead><tbody>';
  filtered.forEach(function(p){
    var idx=manualProducts.indexOf(p);
    var instPrice=p.instant>0?p.price-p.instant:p.price;
    var existBadge=p.existBE>0?'<span class="badge b-exist">'+fmt(p.existBE)+'ì›</span>':'<span class="badge b-none">ì—†ìŒ</span>';
    var curPrice=p.existBE>0?p.price-p.existBE:instPrice;
    var curPriceStr=p.existBE>0?'<span style="color:#6366f1;font-weight:700">'+fmt(curPrice)+'</span>':'<span style="color:#6b7280">'+fmt(instPrice)+'</span>';
    var rv=p.targetPrice!=null&&p.targetPrice>0?p.price-p.targetPrice:0;
    var rvStr=rv>0?'<span style="color:#059669;font-weight:700">-'+fmt(rv)+'</span>':'<span style="color:#d1d5db">-</span>';
    // 2ì°¨ í–‰ì‚¬ê°€ ìœ„ë°˜ ì²´í¬
    var pol=pricePolicy[p.pn];
    var violation=pol&&p.targetPrice&&p.targetPrice<pol.t2;
    var inputClass='price-in'+(p.targetPrice?' changed':'')+(violation?' error':'');
    // ì •ì±… ë°°ì§€
    var polBadge='';
    if(pol)polBadge=' <span style="font-size:9px;color:#9ca3af">('+(pol.regular?'ìƒì‹œ:'+fmt(pol.regular)+' / ':'')+'1ì°¨:'+fmt(pol.t1)+' / 2ì°¨:'+fmt(pol.t2)+')</span>';
    h+='<tr class="dr" style="'+(p.selected?'background:#ecfdf5':'')+(violation?'background:#fef2f2':'')+'">';
    h+='<td><input type="checkbox" class="ck" data-idx="'+idx+'" '+(p.selected?'checked':'')+' onchange="toggleProduct('+idx+',this.checked)"></td>';
    h+='<td class="mono">'+p.pn+'</td><td class="name" title="'+p.name+'">'+p.name+polBadge+'</td>';
    h+='<td class="r" style="color:#374151;font-weight:600">'+fmt(p.price)+'</td>';
    h+='<td class="r" style="color:#ef4444">'+(p.instant?'-'+fmt(p.instant):'-')+'</td>';
    h+='<td class="r">'+fmt(instPrice)+'</td>';
    h+='<td class="r">'+existBadge+'</td>';
    h+='<td class="r">'+curPriceStr+'</td>';
    h+='<td><input type="number" class="'+inputClass+'" data-idx="'+idx+'" value="'+(p.targetPrice||'')+'" placeholder="ìµœì¢…í˜œíƒê°€" min="0" max="'+p.price+'" oninput="setTargetPrice('+idx+',this.value)"></td>';
    h+='<td class="r">'+rvStr+'</td></tr>';
    if(violation)h+='<tr><td colspan="10" class="sub-row" style="color:#ef4444">&nbsp;&nbsp;ğŸš« 2ì°¨ í–‰ì‚¬ê°€('+fmt(pol.t2)+'ì›) ë¯¸ë§Œ! íšŒì‚¬ ì •ì±… ìœ„ë°˜</td></tr>';
    else if(p.existBE>0&&p.existBG){var bg=p.existBG.replace(/\r?\n/g,' ~ ');h+='<tr><td colspan="10" class="sub-row" style="color:#6366f1">&nbsp;&nbsp;ğŸ“Œ ê¸°ì¡´ ì˜ˆì•½í• ì¸: '+fmt(p.existBE)+'ì› Â· '+bg+'</td></tr>'}
  });
  h+='</tbody></table>';con.innerHTML=h;updateManualStats();
}
function toggleProduct(idx,checked){manualProducts[idx].selected=checked;renderManual()}
function toggleAllVisible(checked){var q=(document.getElementById('m-search').value||'').toLowerCase();manualProducts.forEach(function(p){if(!q||p.pn.includes(q)||p.name.toLowerCase().includes(q))p.selected=checked});renderManual()}
function selectAll(v){manualProducts.forEach(function(p){p.selected=v});renderManual()}
function setTargetPrice(idx,val){var p=manualProducts[idx];p.targetPrice=val?Math.round(parseFloat(val)):null;if(p.targetPrice&&!p.selected)p.selected=true;
  // 2ì°¨ í–‰ì‚¬ê°€ ìœ„ë°˜ ì¦‰ì‹œ ì²´í¬
  var pol=pricePolicy[p.pn];
  if(pol&&p.targetPrice&&p.targetPrice<pol.t2){
    showAlert('ğŸš«','ê°€ê²© ì •ì±… ìœ„ë°˜',p.name+'<br><br>ì…ë ¥ê°€: <strong>'+fmt(p.targetPrice)+'ì›</strong><br>2ì°¨ í–‰ì‚¬ê°€(ìµœì €): <strong>'+fmt(pol.t2)+'ì›</strong><br><br>2ì°¨ í–‰ì‚¬ê°€ë³´ë‹¤ ë‚®ì€ ê°€ê²©ì€ íšŒì‚¬ ì •ì±…ì— ìœ„ë°°ë©ë‹ˆë‹¤.','í™•ì¸','#ef4444');
  }
  updateManualStats();
}
function updateManualStats(){var sel=manualProducts.filter(function(p){return p.selected});var valid=sel.filter(function(p){return p.targetPrice&&p.targetPrice>0&&p.price-p.targetPrice>0});document.getElementById('m-sel-count').textContent=sel.length+'ê°œ ì„ íƒ';var total=valid.reduce(function(s,p){return s+(p.price-p.targetPrice)},0);document.getElementById('m-rsv-total').textContent=fmt(total)+'ì›';checkManualReady()}
function checkManualReady(){if(mode!=='manual')return;var sel=manualProducts.filter(function(p){return p.selected&&p.targetPrice&&p.targetPrice>0&&p.price-p.targetPrice>0});document.getElementById('btn-manual-go').disabled=!(sel.length>0&&datesValid())}

// ===== í˜„í™© ì²´í¬ =====
function checkCheckReady(){if(mode!=='check')return;document.getElementById('btn-check').disabled=!files.template;document.getElementById('check-status').textContent=files.template?'ì¤€ë¹„ ì™„ë£Œ âœ“':'ì¼ê´„ìˆ˜ì •ì–‘ì‹ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”'}
async function runCheck(){
  if(!files.template)return;
  var lg=document.getElementById('log');lg.textContent='';lg.style.display='block';
  log('ğŸ” í˜„í™© ì²´í¬ ì‹¤í–‰\n');
  var buf=await files.template.arrayBuffer();var wb=XLSX.read(buf,{type:'array'});
  var ws=wb.Sheets[wb.SheetNames[0]];fixSheetRef(ws);
  var data=XLSX.utils.sheet_to_json(ws,{header:1,raw:true,defval:null});
  var headerRow=-1;
  for(var ri=0;ri<Math.min(10,data.length);ri++){var row=data[ri];if(!row)continue;for(var c=0;c<row.length;c++){if(norm(row[c])==='ìƒí’ˆë²ˆí˜¸'){headerRow=ri;break}}if(headerRow>=0)break}
  if(headerRow<0){showAlert('âŒ','í—¤ë” ì—†ìŒ','ìƒí’ˆë²ˆí˜¸ ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.','í™•ì¸','#ef4444');return}
  var colA=-1,colD=-1,colF=-1,colBA=-1,colBE=-1,colBG=-1;
  var hrow=data[headerRow];
  for(var c=0;c<hrow.length;c++){var n=norm(hrow[c]);if(n==='ìƒí’ˆë²ˆí˜¸')colA=c;if(n==='ìƒí’ˆëª…')colD=c;if(n==='íŒë§¤ê°€')colF=c;if(n.includes('ì¦‰ì‹œí• ì¸ê°’')&&!n.includes('ëª¨ë°”ì¼'))colBA=c;if(n==='ì˜ˆì•½í• ì¸ê°’')colBE=c;if(n==='ì˜ˆì•½í• ì¸ê¸°ê°„')colBG=c}
  if(colBG<0)colBG=colBE+2;
  var priceIssues=[],periodIssues=[],regularIssues=[],okCount=0,activeCount=0;
  window._checkPrice=priceIssues;window._checkPeriod=periodIssues;window._checkRegular=regularIssues;
  var polKeys=Object.keys(pricePolicy);var hasPol=polKeys.length>0;
  // 1) ìƒì‹œê°€ ì²´í¬ (ì „ì²´ ìƒí’ˆ ëŒ€ìƒ, ì˜ˆì•½í• ì¸ ì—¬ë¶€ ë¬´ê´€)
  if(hasPol&&colBA>=0){
    for(var i=headerRow+1;i<data.length;i++){
      var row=data[i];if(!row)continue;if(!isPN(row[colA]))continue;
      var pn=cleanPN(row[colA]);var nm=S(row[colD]);var pr=Math.round(parseFloat(row[colF])||0);
      var ia=row[colBA]!=null?Math.round(parseFloat(row[colBA])||0):0;
      var pol=pricePolicy[pn];
      if(!pol||!pol.regular)continue;
      var currentRegular=ia>0?(pr-ia):pr;
      if(currentRegular!==pol.regular){
        regularIssues.push({pn:pn,name:nm,price:pr,instant:ia,current:currentRegular,expected:pol.regular,diff:currentRegular-pol.regular,row:i+1});
        log('  ğŸ’° R'+(i+1)+' '+pn+': ìƒì‹œê°€ '+fmt(currentRegular)+' â‰  ì •ì±… '+fmt(pol.regular));
      }
    }
    if(regularIssues.length)log('');
  }
  // 2) ì˜ˆì•½í• ì¸ ì²´í¬ (ì§„í–‰ ì¤‘ì¸ ê²ƒë§Œ)
  for(var i=headerRow+1;i<data.length;i++){
    var row=data[i];if(!row)continue;if(!isPN(row[colA]))continue;
    var pn=cleanPN(row[colA]);var nm=S(row[colD]);var pr=Math.round(parseFloat(row[colF])||0);
    var be=row[colBE]!=null?Math.round(parseFloat(row[colBE])||0):0;
    var bg=row[colBG]!=null?S(row[colBG]):'';
    if(!be||!bg)continue;
    var ps=parsePeriod(bg),eS=ps[0],eE=ps[1];
    // í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ì˜ˆì•½í• ì¸ë§Œ ì²´í¬ (ì¢…ë£Œì¼ì´ í˜„ì¬ì‹œì  ì´í›„)
    var now=new Date();
    if(!eS||!eE||eE<now)continue;
    activeCount++;
    var finalPrice=pr-be;
    // ê°€ê²© ì²´í¬: 2ì°¨ í–‰ì‚¬ê°€ ì´í•˜?
    var pol=pricePolicy[pn];
    if(hasPol&&pol&&finalPrice<pol.t2){
      priceIssues.push({pn:pn,name:nm,price:pr,discount:be,finalPrice:finalPrice,t2:pol.t2,diff:pol.t2-finalPrice,row:i+1,start:eS,end:eE});
      log('  ğŸš« R'+(i+1)+' '+pn+': ìµœì¢…ê°€ '+fmt(finalPrice)+' < 2ì°¨ '+fmt(pol.t2));
    }
    // ê¸°ê°„ ì²´í¬: 60ì¼ ì´ˆê³¼?
    if(eS&&eE){
      var days=Math.round((eE-eS)/(1000*60*60*24));
      if(days>60){
        periodIssues.push({pn:pn,name:nm,price:pr,discount:be,start:eS,end:eE,days:days,row:i+1});
        log('  â° R'+(i+1)+' '+pn+': '+days+'ì¼ ('+fmtD(eS)+'~'+fmtD(eE)+')');
      }else{okCount++}
    }else{okCount++}
  }
  // ê²°ê³¼ í‘œì‹œ
  document.getElementById('check-section').style.display='block';
  var sum=document.getElementById('check-summary');
  var totalIssues=priceIssues.length+periodIssues.length+regularIssues.length;
  sum.innerHTML='<div class="stat"><div class="stat-l">ìƒì‹œê°€ ë¶ˆì¼ì¹˜</div><div class="stat-v" style="color:'+(regularIssues.length?'#8b5cf6':'#10b981')+'">'+regularIssues.length+'</div></div>'
    +'<div class="stat"><div class="stat-l">ì§„í–‰ ì¤‘ ì˜ˆì•½í• ì¸</div><div class="stat-v" style="color:#374151">'+activeCount+'</div></div>'
    +'<div class="stat"><div class="stat-l">ê°€ê²© ìœ„ë°˜</div><div class="stat-v" style="color:'+(priceIssues.length?'#ef4444':'#10b981')+'">'+priceIssues.length+'</div></div>'
    +'<div class="stat"><div class="stat-l">ê¸°ê°„ ì´ˆê³¼ (60ì¼+)</div><div class="stat-v" style="color:'+(periodIssues.length?'#f59e0b':'#10b981')+'">'+periodIssues.length+'</div></div>';
  var tbl=document.getElementById('check-tbl');
  if(!totalIssues){
    var okMsg=hasPol?'ì „ì²´ ìƒí’ˆ ìƒì‹œê°€ ì •ìƒ + '+activeCount+'ê°œ ì˜ˆì•½í• ì¸ ìƒí’ˆ ëª¨ë‘ ì •ìƒì…ë‹ˆë‹¤':'ê°€ê²© ì •ì±… ë¯¸ë“±ë¡ â€” '+activeCount+'ê°œ ì˜ˆì•½í• ì¸ ìƒí’ˆì˜ ê¸°ê°„ë§Œ í™•ì¸í–ˆìŠµë‹ˆë‹¤';
    tbl.innerHTML='<div class="empty"><div class="ic">âœ…</div><div style="font-size:16px;font-weight:700;color:#059669;margin-bottom:4px">ë¬¸ì œ ì—†ìŒ</div><div>'+okMsg+'</div></div>';
    document.getElementById('check-foot').textContent='ì „ì²´ í™•ì¸ ì™„ë£Œ';
    document.getElementById('btn-check-dl').style.display='none';
    showAlert('âœ…','í˜„í™© ì²´í¬ ì™„ë£Œ',okMsg,'í™•ì¸');
  }else{
    var h='';
    if(regularIssues.length){
      h+='<div style="font-size:13px;font-weight:700;color:#7c3aed;margin:12px 0 6px">ğŸ’° ìƒì‹œê°€ ë¶ˆì¼ì¹˜ ('+regularIssues.length+'ê±´)</div>';
      h+='<table><thead><tr><th>ìƒí’ˆë²ˆí˜¸</th><th>ìƒí’ˆëª…</th><th class="r">íŒë§¤ê°€</th><th class="r">ì¦‰ì‹œí• ì¸</th><th class="r">í˜„ì¬ ìƒì‹œê°€</th><th class="r">ì •ì±… ìƒì‹œê°€</th><th class="r">ì°¨ì•¡</th></tr></thead><tbody>';
      regularIssues.forEach(function(p){
        var diffAbs=Math.abs(p.diff);var diffSign=p.diff>0?'+':'';
        h+='<tr class="dr" style="background:#f5f3ff">';
        h+='<td class="mono">'+p.pn+'</td><td class="name" title="'+p.name+'">'+p.name+'</td>';
        h+='<td class="r">'+fmt(p.price)+'</td>';
        h+='<td class="r">'+(p.instant?'-'+fmt(p.instant):'<span style="color:#d1d5db">-</span>')+'</td>';
        h+='<td class="r" style="color:#7c3aed;font-weight:700">'+fmt(p.current)+'</td>';
        h+='<td class="r">'+fmt(p.expected)+'</td>';
        h+='<td class="r" style="color:'+(p.diff>0?'#dc2626':'#2563eb')+';font-weight:700">'+diffSign+fmt(p.diff)+'</td>';
        h+='</tr>';
      });
      h+='</tbody></table>';
    }
    if(priceIssues.length){
      h+='<div style="font-size:13px;font-weight:700;color:#ef4444;margin:12px 0 6px">ğŸš« ê°€ê²© ìœ„ë°˜ ('+priceIssues.length+'ê±´)</div>';
      h+='<table><thead><tr><th>ìƒí’ˆë²ˆí˜¸</th><th>ìƒí’ˆëª…</th><th class="r">íŒë§¤ê°€</th><th class="r">ì˜ˆì•½í• ì¸</th><th class="r">ìµœì¢…ê°€</th><th class="r">2ì°¨ í–‰ì‚¬ê°€</th><th class="r">ì°¨ì•¡</th></tr></thead><tbody>';
      priceIssues.forEach(function(p){
        h+='<tr class="dr" style="background:#fef2f2">';
        h+='<td class="mono">'+p.pn+'</td><td class="name" title="'+p.name+'">'+p.name+'</td>';
        h+='<td class="r">'+fmt(p.price)+'</td>';
        h+='<td class="r" style="color:#ef4444">-'+fmt(p.discount)+'</td>';
        h+='<td class="r" style="color:#ef4444;font-weight:700">'+fmt(p.finalPrice)+'</td>';
        h+='<td class="r">'+fmt(p.t2)+'</td>';
        h+='<td class="r" style="color:#dc2626;font-weight:700">-'+fmt(p.diff)+'</td>';
        h+='</tr>';
      });
      h+='</tbody></table>';
    }
    if(periodIssues.length){
      h+='<div style="font-size:13px;font-weight:700;color:#d97706;margin:12px 0 6px">â° ê¸°ê°„ ì´ˆê³¼ ('+periodIssues.length+'ê±´)</div>';
      h+='<table><thead><tr><th>ìƒí’ˆë²ˆí˜¸</th><th>ìƒí’ˆëª…</th><th class="r">íŒë§¤ê°€</th><th class="r">ì˜ˆì•½í• ì¸</th><th>ì‹œì‘ì¼</th><th>ì¢…ë£Œì¼</th><th class="r">ì¼ìˆ˜</th></tr></thead><tbody>';
      periodIssues.forEach(function(p){
        h+='<tr class="dr" style="background:#fffbeb">';
        h+='<td class="mono">'+p.pn+'</td><td class="name" title="'+p.name+'">'+p.name+'</td>';
        h+='<td class="r">'+fmt(p.price)+'</td>';
        h+='<td class="r" style="color:#d97706">-'+fmt(p.discount)+'</td>';
        h+='<td>'+fmtD(p.start)+'</td><td>'+fmtD(p.end)+'</td>';
        h+='<td class="r" style="color:#d97706;font-weight:700">'+p.days+'ì¼</td>';
        h+='</tr>';
      });
      h+='</tbody></table>';
    }
    tbl.innerHTML=h;
    document.getElementById('check-foot').textContent='ìƒì‹œê°€ ë¶ˆì¼ì¹˜ '+regularIssues.length+'ê±´ | ê°€ê²©ìœ„ë°˜ '+priceIssues.length+'ê±´ | ê¸°ê°„ì´ˆê³¼ '+periodIssues.length+'ê±´ | ì •ìƒ '+okCount+'ê±´';
    document.getElementById('btn-check-dl').style.display='inline-block';
    var desc='';
    if(regularIssues.length)desc+='<span style="color:#7c3aed">ğŸ’° ìƒì‹œê°€ ë¶ˆì¼ì¹˜: '+regularIssues.length+'ê±´</span><br>';
    if(priceIssues.length)desc+='<span style="color:#ef4444">ğŸš« ê°€ê²© ìœ„ë°˜: '+priceIssues.length+'ê±´</span> (2ì°¨ í–‰ì‚¬ê°€ ë¯¸ë§Œ)<br>';
    if(periodIssues.length)desc+='<span style="color:#d97706">â° ê¸°ê°„ ì´ˆê³¼: '+periodIssues.length+'ê±´</span> (60ì¼ ì´ˆê³¼)<br>';
    if(!hasPol&&!priceIssues.length)desc+='<span style="color:#9ca3af">ğŸ’¡ ê°€ê²© ì •ì±… ë¯¸ë“±ë¡ â€” ê°€ê²© ìœ„ë°˜ ì²´í¬ë¥¼ ê±´ë„ˆë›°ì—ˆìŠµë‹ˆë‹¤</span><br>';
    showAlert('âš ï¸','ì´ìƒ í•­ëª© '+totalIssues+'ê±´ ë°œê²¬',desc,'í™•ì¸','#ef4444');
  }
  log('\nâœ… ì²´í¬ ì™„ë£Œ: ìƒì‹œê°€ '+regularIssues.length+' | ê°€ê²©ìœ„ë°˜ '+priceIssues.length+' | ê¸°ê°„ì´ˆê³¼ '+periodIssues.length+' | ì •ìƒ '+okCount);
}
function exportCheckResult(){
  var pi=window._checkPrice||[],pe=window._checkPeriod||[],re=window._checkRegular||[];
  if(!pi.length&&!pe.length&&!re.length){alert('ë‹¤ìš´ë¡œë“œí•  ì´ìƒ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤');return}
  var rows=[];
  if(re.length){
    rows.push(['[ ìƒì‹œê°€ ë¶ˆì¼ì¹˜ ]','','','','','','']);
    rows.push(['ìƒí’ˆë²ˆí˜¸','ìƒí’ˆëª…','íŒë§¤ê°€','ì¦‰ì‹œí• ì¸','í˜„ì¬ ìƒì‹œê°€','ì •ì±… ìƒì‹œê°€','ì°¨ì•¡']);
    re.forEach(function(p){rows.push([p.pn,p.name,p.price,p.instant||0,p.current,p.expected,p.diff])});
    rows.push([]);
  }
  if(pi.length){
    rows.push(['[ ê°€ê²© ìœ„ë°˜ ]','','','','','','']);
    rows.push(['ìƒí’ˆë²ˆí˜¸','ìƒí’ˆëª…','íŒë§¤ê°€','ì˜ˆì•½í• ì¸','ìµœì¢…ê°€','2ì°¨ í–‰ì‚¬ê°€','ì°¨ì•¡']);
    pi.forEach(function(p){rows.push([p.pn,p.name,p.price,p.discount,p.finalPrice,p.t2,-p.diff])});
    rows.push([]);
  }
  if(pe.length){
    rows.push(['[ ê¸°ê°„ ì´ˆê³¼ ]','','','','','','']);
    rows.push(['ìƒí’ˆë²ˆí˜¸','ìƒí’ˆëª…','íŒë§¤ê°€','ì˜ˆì•½í• ì¸','ì‹œì‘ì¼','ì¢…ë£Œì¼','ì¼ìˆ˜']);
    pe.forEach(function(p){rows.push([p.pn,p.name,p.price,p.discount,fmtD(p.start),fmtD(p.end),p.days])});
  }
  var ws=XLSX.utils.aoa_to_sheet(rows);
  ws['!cols']=[{wch:10},{wch:16},{wch:50},{wch:12},{wch:12},{wch:12},{wch:30}];
  var wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'í˜„í™©ì²´í¬');
  var now=new Date();var ds=String(now.getMonth()+1).padStart(2,'0')+String(now.getDate()).padStart(2,'0');
  XLSX.writeFile(wb,'í˜„í™©ì²´í¬_ì´ìƒí•­ëª©_'+ds+'.xlsx');
}

// ===== ìˆ˜ë™ ì‹¤í–‰ =====
async function runManual(){
  if(!datesValid()){document.getElementById('date-warn').style.display='block';return}
  // 2ì°¨ í–‰ì‚¬ê°€ ìœ„ë°˜ ìµœì¢… ì²´í¬
  var violations=[];
  manualProducts.filter(function(p){return p.selected&&p.targetPrice}).forEach(function(p){
    var pol=pricePolicy[p.pn];
    if(pol&&p.targetPrice<pol.t2)violations.push(p.name+' (ì…ë ¥: '+fmt(p.targetPrice)+'ì› < 2ì°¨: '+fmt(pol.t2)+'ì›)');
  });
  if(violations.length){showAlert('ğŸš«','ê°€ê²© ì •ì±… ìœ„ë°˜ '+violations.length+'ê±´','ë‹¤ìŒ ìƒí’ˆì´ 2ì°¨ í–‰ì‚¬ê°€ ë¯¸ë§Œì…ë‹ˆë‹¤:<br><br>'+violations.map(function(v){return 'â€¢ '+v}).join('<br>')+'<br><br>ìˆ˜ì • í›„ ë‹¤ì‹œ ì‹¤í–‰í•´ì£¼ì„¸ìš”.','í™•ì¸','#ef4444');return}

  var lg=document.getElementById('log');lg.textContent='';lg.style.display='block';log('âš¡ ìˆ˜ë™ ì„¸íŒ… ì‹¤í–‰\n');
  var sdv=document.getElementById('sd').value,edv=document.getElementById('ed').value;
  var startStr=sdv+' 00:00',endStr=edv+' 23:59';
  var nS=new Date(sdv+'T00:00'),nE=new Date(edv+'T23:59');
  var cols=manualCols,colBE_L=XLSX.utils.encode_col(cols.colBE),colBF_L=XLSX.utils.encode_col(cols.colBF),colBG_L=XLSX.utils.encode_col(cols.colBG);
  log('  ê¸°ê°„: '+startStr+' ~ '+endStr+'\n');
  R={updated:[],extended:[],conflicts:[],warnings:[]};var mods=[];
  var sel=manualProducts.filter(function(p){return p.selected&&p.targetPrice&&p.targetPrice>0});
  sel.forEach(function(p){var nv=p.price-p.targetPrice;var item={id:p.pn,name:p.name,price:p.price,instantDiscount:p.instant,reserveDiscount:Math.abs(nv),finalPrice:p.targetPrice,rowIdx:p.rowIdx};if(nv<=0){item.type='warning';item.reason='íŒë§¤ê°€ <= ìµœì¢…í˜œíƒê°€';R.warnings.push(item);log('  ğŸ’¡ R'+p.excelRow+' '+p.pn+': '+item.reason);return}item.reserveDiscount=nv;var ps=parsePeriod(p.existBG),eS=ps[0],eE=ps[1];var has=p.existBE>0&&p.existBG;if(has&&eS&&eE&&overlap(eS,eE,nS,nE)){if(p.existBE===nv){var ks=fmtFull(eS);mods.push({r:p.excelRow,c:colBG_L,v:ks+'\n'+endStr,t:'s'});item.existPeriod=fmtD(eS)+'~'+fmtD(eE);item.newPeriod=ks.slice(5)+' ~ '+endStr.slice(5);R.extended.push(item);log('  ğŸ”„ R'+p.excelRow+' '+p.pn+': ì—°ì¥');return}else{item.existDiscount=p.existBE;item.existPeriod=fmtD(eS)+'~'+fmtD(eE);item.newPeriod=fmtD(nS)+'~'+fmtD(nE);item.existEnd=eE;R.conflicts.push(item);log('  âš ï¸ R'+p.excelRow+' '+p.pn+': ì¶©ëŒ');return}}mods.push({r:p.excelRow,c:colBE_L,v:nv,t:'n'});mods.push({r:p.excelRow,c:colBF_L,v:'ì›',t:'s'});mods.push({r:p.excelRow,c:colBG_L,v:startStr+'\n'+endStr,t:'s'});R.updated.push(item);log('  âœ… R'+p.excelRow+' '+p.pn+': '+fmt(p.price)+' - '+fmt(p.targetPrice)+' = '+fmt(nv))});
  log('\nğŸ“¦ JSZip ('+mods.length+'ì…€)...');var zip=await JSZip.loadAsync(manualBuf);var sp='xl/worksheets/sheet1.xml';var sx=await zip.file(sp).async('string');var parser=new DOMParser();var doc=parser.parseFromString(sx,'application/xml');var ns=doc.documentElement.namespaceURI;var ok=0;mods.forEach(function(m){if(xmlSetCell(doc,ns,m.r,m.c,m.v,m.t==='n'?'n':'str'))ok++});log('  ìˆ˜ì •: '+ok+'/'+mods.length);zip.file(sp,new XMLSerializer().serializeToString(doc));var blob=await zip.generateAsync({type:'blob',compression:'DEFLATE'});var url=URL.createObjectURL(blob);var a=document.createElement('a');a.href=url;a.download='ì¼ê´„ìˆ˜ì •ì–‘ì‹_ì™„ì„±.xlsx';a.click();URL.revokeObjectURL(url);
  var okN=R.updated.length+R.extended.length,bad=R.conflicts.length+R.warnings.length;
  document.getElementById('s-prop').textContent='ìˆ˜ë™';document.getElementById('s-conf').textContent='-';
  document.getElementById('s-match').textContent=okN;document.getElementById('s-issue').textContent=bad;document.getElementById('s-issue').style.color=bad>0?'#ef4444':'#d1d5db';
  var ps2=[].concat(R.updated,R.extended);document.getElementById('s-rate').textContent=ps2.length?(ps2.reduce(function(s,p){return s+(p.price-p.finalPrice)/p.price},0)/ps2.length*100).toFixed(1)+'%':'0%';
  document.getElementById('t-rsv').textContent=fmt(ps2.reduce(function(s,p){return s+p.reserveDiscount},0))+'ì›';
  renderRes();document.getElementById('res').style.display='block';
  log('\nâœ… ì‹ ê·œ '+R.updated.length+' | ì—°ì¥ '+R.extended.length+' | ì¶©ëŒ '+R.conflicts.length+' | ê²½ê³  '+R.warnings.length);
  // ì™„ë£Œ ì•Œë¦¼
  var desc='ì‹ ê·œ: '+R.updated.length+'ê±´ | ì—°ì¥: '+R.extended.length+'ê±´';
  if(bad)desc+='<br>ì¶©ëŒ: '+R.conflicts.length+'ê±´ | ê²½ê³ : '+R.warnings.length+'ê±´';
  showAlert('âœ…','ì„¸íŒ… ì™„ë£Œ â€” '+okN+'ê±´ ì²˜ë¦¬',desc,'í™•ì¸');
}

// ===== ìë™ ì‹¤í–‰ =====
async function run(){if(!datesValid()){document.getElementById('date-warn').style.display='block';return}var stEl=document.getElementById('status');var lg=document.getElementById('log');lg.textContent='';lg.style.display='block';stEl.textContent='â³ ì²˜ë¦¬ ì¤‘...';log('ğŸ” ìŠ¤ë§ˆíŠ¸ íŒŒì„œ v6.0\n');try{log('ğŸ“„ ì œì•ˆ íŒŒì¼...');var wb1=await readXL(files.proposal);var proposal=smartExtract(wb1);var targetPNs;if(mode==='naver'&&files.confirmed){log('\nğŸ“„ í™•ì • íŒŒì¼...');var wb2=await readXL(files.confirmed);var confirmed=smartExtractConfirmed(wb2);targetPNs=new Set(Object.keys(proposal).filter(function(p){return confirmed[p]}));for(var pn of targetPNs){if(confirmed[pn].price)proposal[pn].price=confirmed[pn].price}log('\nğŸ“‹ ì œì•ˆ: '+Object.keys(proposal).length+' | âœ… í™•ì •: '+Object.keys(confirmed).length+' | ğŸ¯ ë§¤ì¹­: '+targetPNs.size);window._statConf=Object.keys(confirmed).length}else{targetPNs=new Set(Object.keys(proposal));log('\nğŸ“‹ ë‚´ë¶€: '+targetPNs.size+'ê°œ');window._statConf='-'}if(!targetPNs.size){stEl.textContent='âš ï¸ ë§¤ì¹­ ì—†ìŒ';return}log('\nğŸ“„ ì¼ê´„ìˆ˜ì •ì–‘ì‹...');var tmplBuf=await readBuf(files.template);var wb4=XLSX.read(tmplBuf,{type:'array'});var wsN=wb4.SheetNames[0];var ws4=wb4.Sheets[wsN];var ref4=fixSheetRef(ws4);log('  !ref: '+ref4.oldRef+' -> '+ref4.newRef);var data=XLSX.utils.sheet_to_json(ws4,{header:1,raw:true,defval:null});log('  '+data.length+'í–‰');var headerRow=-1;for(var ri=0;ri<Math.min(10,data.length);ri++){var row=data[ri];if(!row)continue;for(var c=0;c<row.length;c++){if(norm(row[c])==='ìƒí’ˆë²ˆí˜¸'){headerRow=ri;break}}if(headerRow>=0)break}if(headerRow<0){stEl.textContent='âŒ í—¤ë” ì‹¤íŒ¨';return}var colA=-1,colD=-1,colF=-1,colBA=-1,colBE=-1,colBF=-1,colBG=-1;var hrow=data[headerRow];for(var c=0;c<hrow.length;c++){var n=norm(hrow[c]);if(n==='ìƒí’ˆë²ˆí˜¸')colA=c;if(n==='ìƒí’ˆëª…')colD=c;if(n==='íŒë§¤ê°€')colF=c;if(n.includes('ì¦‰ì‹œí• ì¸ê°’')&&!n.includes('ëª¨ë°”ì¼'))colBA=c;if(n==='ì˜ˆì•½í• ì¸ê°’')colBE=c;if(n==='ì˜ˆì•½í• ì¸ë‹¨ìœ„')colBF=c;if(n==='ì˜ˆì•½í• ì¸ê¸°ê°„')colBG=c}if(colA<0||colF<0||colBE<0){stEl.textContent='âŒ ì»¬ëŸ¼ ëˆ„ë½';return}if(colBG<0)colBG=colBE+2;if(colBF<0)colBF=colBE+1;var colBE_L=XLSX.utils.encode_col(colBE),colBF_L=XLSX.utils.encode_col(colBF),colBG_L=XLSX.utils.encode_col(colBG);var sdv=document.getElementById('sd').value,edv=document.getElementById('ed').value;var startStr=sdv+' 00:00',endStr=edv+' 23:59';var nS=new Date(sdv+'T00:00'),nE=new Date(edv+'T23:59');log('  ê¸°ê°„: '+startStr+' ~ '+endStr+'\n');R={updated:[],extended:[],conflicts:[],warnings:[]};var mods=[];for(var i=0;i<data.length;i++){var row=data[i];if(!row)continue;var raw=row[colA];if(!isPN(raw))continue;var pn=cleanPN(raw);if(!targetPNs.has(pn))continue;var excelRow=i+1;var nm=S(row[colD]);var pr=Math.round(parseFloat(row[colF])||0);var id_=colBA>=0?Math.round(parseFloat(row[colBA])||0):0;var eventPrice=proposal[pn].price;var nv=pr-eventPrice;var item={id:pn,name:nm||proposal[pn].name,price:pr,instantDiscount:id_,reserveDiscount:Math.abs(nv),finalPrice:eventPrice,rowIdx:i};if(nv<=0){item.type='warning';item.reason='íŒë§¤ê°€('+fmt(pr)+') <= ìµœì¢…í˜œíƒê°€('+fmt(eventPrice)+')';R.warnings.push(item);log('  ğŸ’¡ R'+excelRow+' '+pn+': '+item.reason);continue}item.reserveDiscount=nv;var ev=row[colBE]!=null?Math.round(parseFloat(row[colBE])||0):null;var eg=row[colBG]!=null?S(row[colBG]):null;var pp=parsePeriod(eg),eS=pp[0],eE=pp[1];var has=ev!=null&&ev>0&&eg!=null;if(has&&eS&&eE&&overlap(eS,eE,nS,nE)){if(ev===nv){var ks=fmtFull(eS);mods.push({r:excelRow,c:colBG_L,v:ks+'\n'+endStr,t:'s'});item.existPeriod=fmtD(eS)+'~'+fmtD(eE);item.newPeriod=ks.slice(5)+' ~ '+endStr.slice(5);R.extended.push(item);log('  ğŸ”„ R'+excelRow+' '+pn);continue}else{item.existDiscount=ev;item.existPeriod=fmtD(eS)+'~'+fmtD(eE);item.newPeriod=fmtD(nS)+'~'+fmtD(nE);item.existEnd=eE;R.conflicts.push(item);log('  âš ï¸ R'+excelRow+' '+pn+': ì¶©ëŒ');continue}}mods.push({r:excelRow,c:colBE_L,v:nv,t:'n'});mods.push({r:excelRow,c:colBF_L,v:'ì›',t:'s'});mods.push({r:excelRow,c:colBG_L,v:startStr+'\n'+endStr,t:'s'});R.updated.push(item);log('  âœ… R'+excelRow+' '+pn+': '+fmt(pr)+' - '+fmt(eventPrice)+' = '+fmt(nv))}log('\nğŸ“¦ JSZip ('+mods.length+'ì…€)...');var zip=await JSZip.loadAsync(tmplBuf);var sp='xl/worksheets/sheet1.xml';var sx=await zip.file(sp).async('string');var parser=new DOMParser();var doc=parser.parseFromString(sx,'application/xml');var ns=doc.documentElement.namespaceURI;var ok=0;mods.forEach(function(m){if(xmlSetCell(doc,ns,m.r,m.c,m.v,m.t==='n'?'n':'str'))ok++});log('  ìˆ˜ì •: '+ok+'/'+mods.length);zip.file(sp,new XMLSerializer().serializeToString(doc));var blob=await zip.generateAsync({type:'blob',compression:'DEFLATE'});var url=URL.createObjectURL(blob);var a=document.createElement('a');a.href=url;a.download='ì¼ê´„ìˆ˜ì •ì–‘ì‹_ì™„ì„±.xlsx';a.click();URL.revokeObjectURL(url);document.getElementById('s-prop').textContent=Object.keys(proposal).length;document.getElementById('s-conf').textContent=mode==='internal'?'ë‚´ë¶€':window._statConf||'-';document.getElementById('s-conf-label').textContent=mode==='naver'?'í™•ì •':'ëª¨ë“œ';var okN=R.updated.length+R.extended.length,bad=R.conflicts.length+R.warnings.length;document.getElementById('s-match').textContent=okN;document.getElementById('s-issue').textContent=bad;document.getElementById('s-issue').style.color=bad>0?'#ef4444':'#d1d5db';var ps2=[].concat(R.updated,R.extended);document.getElementById('s-rate').textContent=ps2.length?(ps2.reduce(function(s,p){return s+(p.price-p.finalPrice)/p.price},0)/ps2.length*100).toFixed(1)+'%':'0%';document.getElementById('t-rsv').textContent=fmt(ps2.reduce(function(s,p){return s+p.reserveDiscount},0))+'ì›';renderRes();document.getElementById('res').style.display='block';stEl.textContent='âœ… '+okN+'ê±´ ì™„ë£Œ';
  log('\nâœ… ì‹ ê·œ '+R.updated.length+' | ì—°ì¥ '+R.extended.length+' | ì¶©ëŒ '+R.conflicts.length+' | ê²½ê³  '+R.warnings.length);
  // ì™„ë£Œ ì•Œë¦¼
  var desc='ì‹ ê·œ: '+R.updated.length+'ê±´ | ì—°ì¥: '+R.extended.length+'ê±´';
  if(bad)desc+='<br>ì¶©ëŒ: '+R.conflicts.length+'ê±´ | ê²½ê³ : '+R.warnings.length+'ê±´';
  showAlert('âœ…','ì„¸íŒ… ì™„ë£Œ â€” '+okN+'ê±´ ì²˜ë¦¬',desc,'í™•ì¸');
  }catch(err){stEl.textContent='âŒ '+err.message;log('âŒ '+err.message+'\n'+err.stack)}}

// ===== ê²°ê³¼ í…Œì´ë¸” =====
function renderRes(){var all=[].concat(R.updated.map(function(p){return Object.assign({},p,{type:'new'})}),R.extended.map(function(p){return Object.assign({},p,{type:'extended'})}),R.conflicts.map(function(p){return Object.assign({},p,{type:'conflict'})}),R.warnings.map(function(p){return Object.assign({},p,{type:'warning'})}));var cnt={all:all.length,new:R.updated.length,extended:R.extended.length,conflict:R.conflicts.length,warning:R.warnings.length};var te=document.getElementById('tabs');te.innerHTML='';[{k:'all',l:'ì „ì²´'},{k:'new',l:'ì‹ ê·œ'},{k:'extended',l:'ì—°ì¥'},{k:'conflict',l:'ì¶©ëŒ'},{k:'warning',l:'ê²½ê³ '}].forEach(function(t){if(t.k!=='all'&&cnt[t.k]===0)return;var b=document.createElement('button');b.className='tab'+(activeTab===t.k?' on':'');b.innerHTML=t.l+'<span class="tab-c">'+cnt[t.k]+'</span>';b.onclick=function(){activeTab=t.k;renderRes()};te.appendChild(b)});var fl=activeTab==='all'?all:all.filter(function(x){return x.type===activeTab});var con=document.getElementById('tbl');if(!fl.length){con.innerHTML='<div class="empty"><div class="ic">ğŸ“­</div><div>í•­ëª© ì—†ìŒ</div></div>';return}var bc={new:'b-new',extended:'b-ext',conflict:'b-con',warning:'b-warn'};var bl={new:'âœ… ì‹ ê·œ',extended:'ğŸ”„ ì—°ì¥',conflict:'âš ï¸ ì¶©ëŒ',warning:'ğŸ’¡ ê²½ê³ '};var tbg={new:'#ecfdf5',extended:'#fffbeb',conflict:'#fef2f2',warning:'#fff7ed'};var tcl={new:'#059669',extended:'#d97706',conflict:'#dc2626',warning:'#ea580c'};var h='<table><thead><tr>';['ìƒíƒœ','ìƒí’ˆë²ˆí˜¸','ìƒí’ˆëª…','íŒë§¤ê°€','ì˜ˆì•½í• ì¸(BE)','ìµœì¢…í˜œíƒê°€','í• ì¸ìœ¨'].forEach(function(v,i){h+='<th'+(i>=3?' class="r"':'')+'>'+v+'</th>'});h+='</tr></thead><tbody>';fl.forEach(function(p){var rate=p.price>0?((p.price-p.finalPrice)/p.price*100).toFixed(1):'0';h+='<tr class="dr"><td><span class="badge '+bc[p.type]+'">'+bl[p.type]+'</span></td>';h+='<td class="mono">'+p.id+'</td><td class="name" title="'+p.name+'">'+p.name+'</td>';h+='<td class="r" style="color:#374151">'+fmt(p.price)+'</td>';if(p.type==='warning')h+='<td class="r" style="color:#ea580c">-</td>';else h+='<td class="r"><span style="font-weight:700;padding:4px 10px;border-radius:7px;background:'+tbg[p.type]+';color:'+tcl[p.type]+'">-'+fmt(p.reserveDiscount)+'</span></td>';h+='<td class="r" style="font-weight:700;color:#111827">'+fmt(p.finalPrice)+'</td>';h+='<td class="r"><span style="font-size:11px;font-weight:600;padding:4px 8px;border-radius:7px;background:'+(parseFloat(rate)>=40?'#fef2f2':'#f3f4f6')+';color:'+(parseFloat(rate)>=40?'#dc2626':'#6b7280')+'">'+rate+'%</span></td></tr>';if(p.type==='conflict')h+='<tr><td colspan="7" class="sub-row">&nbsp;&nbsp;âš ï¸ ê¸°ì¡´: '+fmt(p.existDiscount)+'ì› ('+p.existPeriod+') vs ì‹ ê·œ: '+fmt(p.reserveDiscount)+'ì›</td></tr>';if(p.type==='extended')h+='<tr><td colspan="7" class="sub-row">&nbsp;&nbsp;ğŸ”„ '+p.newPeriod+'</td></tr>';if(p.type==='warning')h+='<tr><td colspan="7" class="sub-row">&nbsp;&nbsp;ğŸ’¡ '+p.reason+'</td></tr>'});h+='</tbody></table>';con.innerHTML=h}

// ì´ˆê¸°í™”
loadPolicy();
</script>
</body>
</html>
